<!DOCTYPE html>
<html class="light" lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>NITC Reporting - Forgot Password</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#0d7ff2",
            "background-light": "#f5f7f8",
            "background-dark": "#101922",
            "surface-light": "#ffffff",
            "surface-dark": "#1a242d"
          },
          fontFamily: {
            display: ["Inter", "sans-serif"]
          }
        }
      }
    };
  </script>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-slate-900 dark:text-white min-h-screen flex items-center justify-center p-6">
  <div class="w-full max-w-md bg-surface-light dark:bg-surface-dark rounded-xl shadow-lg p-6 sm:p-8 space-y-6">
    <div class="flex items-center gap-2 text-primary">
      <span class="material-symbols-outlined">lock_reset</span>
      <h1 class="text-2xl font-bold">Forgot Password</h1>
    </div>

    <p class="text-sm text-slate-600 dark:text-slate-400">Use your registered NITC email to reset password through OTP verification.</p>

    <div id="statusBox" class="hidden rounded-lg border px-4 py-3 text-sm"></div>

    <form id="requestOtpForm" class="space-y-4">
      <h2 class="text-sm font-semibold uppercase tracking-wide text-slate-500">Step 1: Request OTP</h2>
      <div>
        <label class="block text-sm font-medium mb-1" for="reset-email">NITC Email ID</label>
        <input id="reset-email" name="email" type="email" required placeholder="b190000cs@nitc.ac.in" class="w-full rounded-lg border border-slate-300 dark:border-slate-700 px-3 py-2.5 bg-white dark:bg-slate-800"/>
      </div>
      <button type="submit" class="w-full bg-primary hover:bg-blue-600 text-white font-semibold py-2.5 rounded-lg">Send OTP</button>
    </form>

    <form id="verifyOtpForm" class="space-y-4">
      <h2 class="text-sm font-semibold uppercase tracking-wide text-slate-500">Step 2: Verify OTP</h2>
      <div>
        <label class="block text-sm font-medium mb-1" for="otp-input">6-digit OTP</label>
        <input id="otp-input" name="otp" type="text" inputmode="numeric" minlength="6" maxlength="6" required placeholder="123456" class="w-full rounded-lg border border-slate-300 dark:border-slate-700 px-3 py-2.5 bg-white dark:bg-slate-800"/>
      </div>
      <button type="submit" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-semibold py-2.5 rounded-lg">Verify OTP</button>
    </form>

    <form id="resetPasswordForm" class="space-y-4">
      <h2 class="text-sm font-semibold uppercase tracking-wide text-slate-500">Step 3: Reset Password</h2>
      <div>
        <label class="block text-sm font-medium mb-1" for="new-password">New Password</label>
        <input id="new-password" name="new_password" type="password" required minlength="8" class="w-full rounded-lg border border-slate-300 dark:border-slate-700 px-3 py-2.5 bg-white dark:bg-slate-800"/>
      </div>
      <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2.5 rounded-lg">Reset Password</button>
    </form>

    <div class="text-sm text-center">
      <a href="/" class="font-medium text-primary hover:text-blue-600">Back to Login</a>
    </div>
  </div>

  <script>
    (function () {
      const statusBox = document.getElementById("statusBox");
      const emailInput = document.getElementById("reset-email");
      const otpInput = document.getElementById("otp-input");
      let otpVerified = false;

      function showStatus(message, type) {
        statusBox.classList.remove("hidden", "border-red-200", "bg-red-50", "text-red-700", "border-emerald-200", "bg-emerald-50", "text-emerald-700");
        if (type === "error") {
          statusBox.classList.add("border-red-200", "bg-red-50", "text-red-700");
        } else {
          statusBox.classList.add("border-emerald-200", "bg-emerald-50", "text-emerald-700");
        }
        statusBox.textContent = message;
      }

      async function postJson(path, payload) {
        const res = await fetch(path, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(() => ({}));
        return { ok: res.ok, data };
      }

      document.getElementById("requestOtpForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = emailInput.value.trim().toLowerCase();
        otpVerified = false;
        const { data } = await postJson("/password/otp/request", { email });
        showStatus(data.message || "If the account exists, an OTP has been sent.", "success");
      });

      document.getElementById("verifyOtpForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = emailInput.value.trim().toLowerCase();
        const otp = otpInput.value.trim();
        const { ok, data } = await postJson("/password/otp/verify", { email, otp });
        otpVerified = ok;
        showStatus(data.message || (ok ? "OTP verified." : "Unable to verify OTP."), ok ? "success" : "error");
      });

      emailInput.addEventListener("input", () => { otpVerified = false; });
      otpInput.addEventListener("input", () => { otpVerified = false; });

      document.getElementById("resetPasswordForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!otpVerified) {
          showStatus("Please verify OTP before resetting password.", "error");
          return;
        }
        const email = emailInput.value.trim().toLowerCase();
        const newPassword = document.getElementById("new-password").value;
        const otp = otpInput.value.trim();
        const { ok, data } = await postJson("/password/reset", { email, otp, new_password: newPassword });
        showStatus(data.message || (ok ? "Password reset successful." : "Unable to reset password."), ok ? "success" : "error");
        if (ok) {
          setTimeout(() => { window.location.href = "/"; }, 1200);
        }
      });
    })();
  </script>
</body>
</html>
